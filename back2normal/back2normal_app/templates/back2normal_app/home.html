{% load static %}
<!DOCTYPE html>
<html>
<head>

    <!--<meta-->
    <!--name="viewport"-->
    <!--content="initial-scale=1,maximum-scale=1,user-scalable=no"-->
    <!--/>-->
    <title>back2normal</title>
    <link href="{% static 'css/back2normal_app.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Audiowide|Rajdhani" rel="stylesheet">
    <link href=”http://cdn.pydata.org/bokeh/release/bokeh-1.0.4.min.css" rel=”stylesheet” type=”text/css”>
    <link href=”http://cdn.pydata.org/bokeh/release/bokeh-widgets-1.0.4.min.css" rel=”stylesheet” type=”text/css”>

    <!--<script src="https://code.jquery.com/jquery-3.5.0.js"></script>-->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script type="text/javascript" src="static/demographic_data.js"></script>

</head>

<body>
<div class="title">back2normal</div>
<!-- Navigation Bar -->
<div id="navbar">
    <div id="dash">Dashboard</div>
    <div id="about">About</div>
</div>

<div id="main" class="float-container">

    <div class="float-child">
        <div id="map" class="leaflet-container leaflet-retina leaflet-fade-anim" tabindex="0"
             style="position: relative;"></div>
    </div>

    <div class="float-child">
        <div id="barChart"></div>
    </div>
</div>

</body>
</html>

<script>

    var map = new L.Map("map", {center: [41.83813, -87.72998], zoom: 11})
        .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

    // turn off map zoom
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.scrollWheelZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();

    var svg = d3.select(map.getPanes().overlayPane).append("svg"),
        g = svg.append("g").attr("class", "leaflet-zoom-hide");

    var labels = svg.append("svg:g")
        .attr("id", "labels")
        .attr("class", "Title");

    d3.json("{% static 'Boundaries - ZIP Codes.geojson' %}", function (error, collection) {
        if (error) throw error;

        var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);

        var feature = g.selectAll("path")
            .data(collection.features)
            .enter().append("path");

        map.on("viewreset", reset);
        reset();

        // Reposition the SVG to cover the features.
        function reset() {
            var bounds = path.bounds(collection),
                topLeft = bounds[0],
                bottomRight = bounds[1];

            svg.attr("width", bottomRight[0] - topLeft[0])
                .attr("height", bottomRight[1] - topLeft[1])
                .style("left", topLeft[0] + "px")
                .style("top", topLeft[1] + "px");

            g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

            feature.attr("d", path);
        }

        var clickChart = d3.selectAll("path").on("click", function (e) {
            console.log(e.properties.zip)
            updateBarChart(String(e.properties.zip), 1)

        })

        // Use Leaflet to implement a D3 geometric transformation.
        function projectPoint(x, y) {
            var point = map.latLngToLayerPoint(new L.LatLng(y, x));
            this.stream.point(point.x, point.y);
        }

    });


</script>

<script>

    var label_lookup = {"unemploy_rate" : "Unemployed",
            "pct_below_poverty_lvl": "In poverty",
            "pct_65_or_older": "Age >= 65",
            "pct_w_health_insur": "w/ health insurance"
    }

    var formatAsPercentage = d3.format("%"),
        formatAsPercentage1Dec = d3.format(".1%"),
        formatAsInteger = d3.format(","),
        fsec = d3.time.format("%S s"),
        fmin = d3.time.format("%M m"),
        fhou = d3.time.format("%H h"),
        fwee = d3.time.format("%a"),
        fdat = d3.time.format("%d d"),
        fmon = d3.time.format("%b")
    ;

    var datasetBarChart = demographic_data
    ;

    var group = "60637";

    function datasetBarChosen(group) {
        var ds = [];
        for (x in datasetBarChart) {
            console.log(datasetBarChart[x])
            console.log(datasetBarChart[x].ZIPCODE)

            if (datasetBarChart[x].ZIPCODE == group) {
                if (['unemploy_rate', 'pct_below_poverty_lvl', 'pct_65_or_older', 'pct_w_health_insur'].includes(datasetBarChart[x].CATEGORY)) {
                    ds.push(datasetBarChart[x]);
                }
            }
        }
        return ds;
    }

    function dsBarChartBasics() {

        var margin = {top: 30, right: 5, bottom: 20, left: 50},
            width = 500 - margin.left - margin.right,
            height = 250 - margin.top - margin.bottom,
            colorBar = d3.scale.category20(),
            barPadding = 1
        ;

        return {
            margin: margin,
            width: width,
            height: height,
            colorBar: colorBar,
            barPadding: barPadding
        }
            ;
    }

    function dsBarChart() {

        var firstDatasetBarChart = datasetBarChosen(group);

        var basics = dsBarChartBasics();

        var margin = basics.margin,
            width = basics.width,
            height = basics.height,
            colorBar = basics.colorBar,
            barPadding = basics.barPadding
        ;

        var xScale = d3.scale.linear()
            .domain([0, firstDatasetBarChart.length])
            .range([0, width])
        ;

        // Create linear y scale
        // Purpose: No matter what the data is, the bar should fit into the svg area; bars should not
        // get higher than the svg height. Hence incoming data needs to be scaled to fit into the svg area.
        var yScale = d3.scale.linear()
            // use the max funtion to derive end point of the domain (max value of the dataset)
            // do not use the min value of the dataset as min of the domain as otherwise you will not see the first bar
                .domain([0, d3.max(firstDatasetBarChart, function (d) {
                    return d.VALUE;
                })])
                // As coordinates are always defined from the top left corner, the y position of the bar
                // is the svg height minus the data value. So you basically draw the bar starting from the top.
                // To have the y position calculated by the range function
                .range([height, 0])
        ;

        //Create SVG element

        var svg = d3.select("#barChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("id", "barChartPlot")
        ;

        var plot = svg
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        ;

        plot.selectAll("rect")
            .data(firstDatasetBarChart)
            .enter()
            .append("rect")
            .attr("x", function (d, i) {
                return xScale(i);
            })
            .attr("width", width / firstDatasetBarChart.length - barPadding)
            .attr("y", function (d) {
                return yScale(d.VALUE);
            })
            .attr("height", function (d) {
                return height - yScale(d.VALUE);
            })
            .attr("fill", "lightgrey")
        ;


        // Add y labels to plot

        plot.selectAll("text")
            .data(firstDatasetBarChart)
            .enter()
            .append("text")
            .text(function (d) {
                return formatAsPercentage1Dec(d.VALUE/100);
            })
            .attr("text-anchor", "middle")
            // Set x position to the left edge of each bar plus half the bar width
            .attr("x", function (d, i) {
                return (i * (width / firstDatasetBarChart.length)) + ((width / firstDatasetBarChart.length - barPadding) / 2);
            })
            .attr("y", function (d) {
                return yScale(d.VALUE) + 14;
            })
            .attr("class", "yAxis")
        /* moved to CSS
        .attr("font-family", "sans-serif")
        .attr("font-size", "11px")
        .attr("fill", "white")
        */
        ;

        // Add x labels to chart

        var xLabels = svg
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + (margin.top + height) + ")")
        ;

        xLabels.selectAll("text.xAxis")
            .data(firstDatasetBarChart)
            .enter()
            .append("text")
            .text(function (d) {
                return label_lookup[d.CATEGORY];
            })
            .attr("text-anchor", "middle")
            // Set x position to the left edge of each bar plus half the bar width
            .attr("x", function (d, i) {
                return (i * (width / firstDatasetBarChart.length)) + ((width / firstDatasetBarChart.length - barPadding) / 2);
            })
            .attr("y", 15)
            .attr("class", "xAxis")
        //.attr("style", "font-size: 12; font-family: Helvetica, sans-serif")
        ;

        // Title

        svg.append("text")
            .attr("x", (width + margin.left + margin.right) / 2)
            .attr("y", 15)
            .attr("class", "chart_title")
            .attr("text-anchor", "middle")
            .text("hiiii")
        ;
    }

    dsBarChart();

    function updateBarChart(group, colorChosen) {

        console.log(group)
        console.log(typeof(group))

        var currentDatasetBarChart = datasetBarChosen(group);
        console.log(currentDatasetBarChart)

        var basics = dsBarChartBasics();

        var margin = basics.margin,
            width = basics.width,
            height = basics.height,
            colorBar = basics.colorBar,
            barPadding = basics.barPadding
        ;

        var xScale = d3.scale.linear()
            .domain([0, currentDatasetBarChart.length])
            .range([0, width])
        ;


        var yScale = d3.scale.linear()
            .domain([0, d3.max(currentDatasetBarChart, function (d) {
                return d.VALUE;
            })])
            .range([height, 0])
        ;

        var svg = d3.select("#barChart svg");

        var plot = d3.select("#barChartPlot")
            .datum(currentDatasetBarChart)
        ;

        /* Note that here we only have to select the elements - no more appending! */
        plot.selectAll("rect")
            .data(currentDatasetBarChart)
            .transition()
            .duration(750)
            .attr("x", function (d, i) {
                return xScale(i);
            })
            .attr("width", width / currentDatasetBarChart.length - barPadding)
            .attr("y", function (d) {
                return yScale(d.VALUE);
            })
            .attr("height", function (d) {
                return height - yScale(d.VALUE);
            })
            .attr("fill", colorChosen)
        ;

        plot.selectAll("text.yAxis") // target the text element(s) which has a yAxis class defined
            .data(currentDatasetBarChart)
            .transition()
            .duration(750)
            .attr("text-anchor", "middle")
            .attr("x", function (d, i) {
                return (i * (width / currentDatasetBarChart.length)) + ((width / currentDatasetBarChart.length - barPadding) / 2);
            })
            .attr("y", function (d) {
                return yScale(d.VALUE) + 14;
            })
            .text(function (d) {
                return formatAsPercentage1Dec(d.VALUE/100);
            })
            .attr("class", "yAxis")
        ;


        svg.selectAll("text.chart_title") // target the text element(s) which has a title class defined
            .attr("x", (width + margin.left + margin.right) / 2)
            .attr("y", 15)
            .attr("class", "chart_title")
            .attr("text-anchor", "middle")
            .text(group + " Demographic Data")
        ;
    }


</script>


<style>

    @import url(//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.css);

    #map {
        width: 640px;
        height: 760px;
    }

    #map svg {
        position: relative;
    }

    #map path {
        fill: #000;
        fill-opacity: .2;
        stroke: #fff;
        stroke-width: 1.5px;
    }

    #map path:hover {
        fill: brown;
        fill-opacity: .7;
    }

    .d3-tip {
        line-height: 1;
        padding: 12px;
        background: rgba(43, 43, 43, 0.8);
        color: #fff;
        border-radius: 2px;
    }

    #barChart {
        position: relative;
        /*top:160px;*/
        /*left:410px;*/
        height: 250px;
    }

    .axis text {
        font-family: Verdana;
        font-size: 11px;
    }

    .chart_title {
        font-family: Verdana;
        font-size: 15px;

    }

    .xAxis {
        font-family: verdana;
        font-size: 11px;
        fill: black;
    }

    .yAxis {
        font-family: verdana;
        font-size: 11px;
        fill: white;
    }

    table {
        border-collapse: collapse;
        border: 0px;
        font-family: Verdana;
        color: #5C5558;
        font-size: 12px;
        text-align: right;
    }


</style>
